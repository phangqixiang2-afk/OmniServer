<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>Welcome, {{ username }}</h2>
  <a href="/logout">Logout</a>

  <h3>Live Environment Charts</h3>
  <canvas id="envChart" width="400" height="200"></canvas>

  <h3>Recent Sensor Data</h3>
  <table border="1">
    <tr><th>Time</th><th>Temp (°C)</th><th>Humidity (%)</th><th>Gas</th><th>Dust</th></tr>
    <tbody id="dataTable"></tbody>
  </table>

  <script>
    const ctx = document.getElementById('envChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Temp °C', borderColor: 'red', data: [], fill: false },
          { label: 'Humidity %', borderColor: 'blue', data: [], fill: false },
          { label: 'Gas', borderColor: 'green', data: [], fill: false },
          { label: 'Dust', borderColor: 'orange', data: [], fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    async function refreshData() {
      const res = await fetch('/latest');
      const json = await res.json();
      const data = json.data.reverse();   // oldest first
      const labels = data.map(r => r[4]);
      const temps = data.map(r => r[0]);
      const hums  = data.map(r => r[1]);
      const gas   = data.map(r => r[2]);
      const dust  = data.map(r => r[3]);

      chart.data.labels = labels;
      chart.data.datasets[0].data = temps;
      chart.data.datasets[1].data = hums;
      chart.data.datasets[2].data = gas;
      chart.data.datasets[3].data = dust;
      chart.update();

      // update table
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = '';
      data.forEach(r => {
        tbody.innerHTML += `<tr>
          <td>${r[4]}</td><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
        </tr>`;
      });
    }

    refreshData();
    setInterval(refreshData, 5000);
  </script>
</body>
</html>
